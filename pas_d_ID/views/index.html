<!DOCTYPE html>
<html lang="en">

  <head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>pas_d_ID</title>

    <!-- Bootstrap core CSS -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom fonts for this template -->
    <link rel="stylesheet" href="vendor/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="vendor/simple-line-icons/css/simple-line-icons.css">
    <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Catamaran:100,200,300,400,500,600,700,800,900" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Muli" rel="stylesheet">

    <!-- Plugin CSS -->
    <link rel="stylesheet" href="device-mockups/device-mockups.min.css">

    <!-- Custom styles for this template -->
    <link href="css/new-age.min.css" rel="stylesheet">

  </head>

  <body id="page-top">

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
      <div class="container">
        <a class="navbar-brand js-scroll-trigger" href="#page-top">pas_d_ID</a>
        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
          Menu
          <i class="fa fa-bars"></i>
        </button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
          <ul class="navbar-nav ml-auto">
            <li class="nav-item">
              <a class="nav-link js-scroll-trigger" href="#download">Download</a>
            </li>
            <li class="nav-item">
              <a class="nav-link js-scroll-trigger" href="#features">Features</a>
            </li>
            <li class="nav-item">
              <a class="nav-link js-scroll-trigger" href="#contact">Contact</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <header class="masthead">
      <div class="container h-100">
        <div class="row h-100">
          <div class="col-lg-12 my-auto">
            <div class="header-content mx-auto">
              <h1 class="mb-5">pas_d_ID, le site de chat où il fait bon venir quand t'as pas d'idées</h1>
              <!--<a href="#download" class="btn btn-outline btn-xl js-scroll-trigger">Go!</a>-->
            </div>
          </div>
		  <div id="map"></div>
		  <!--<form action="" id="newRoom">
			<input type="text" id="message" class="text" />
			<input type="submit" id="send" value="newRoom" class="submit" />
		  </form>-->
        </div>
      </div>
    </header>

	<section id="chooseName" class="cta">
      <div class="cta-content">
        <div class="container">
          <form action="" id="newUser">
					<input class="form-control" type="text" id="usr" class="text" placeholder="Enter pseudo"/>
					<small class="form-text text-muted">Choose a name before choosing a room ;)</small>
					<input type="submit" id="send" class="btn btn-primary" value="newUser" class="submit" />
				  </form>
        </div>
      </div>
      <div class="overlay"></div>
    </section>
	
    <section class="features" id="features">
      <div class="container">
		  
    <div class="row">
        <div class="col-md-12">
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <span class="glyphicon glyphicon-comment"></span><p id="roomName"> Chat Unknown</p>
                    <div class="btn-group pull-right">
                        <button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown">
                            <span id="nbUsrs" class="glyphicon glyphicon-chevron-down">0</span>
                        </button>
                        <ul id="rooms" class="dropdown-menu slidedown">
                        </ul>
                    </div>
                </div>
                <div class="panel-body">
                    <ul id="conversation" class="chat">
                    </ul>
                </div>
                <div class="panel-footer">
                    <div class="input-group">
                        <input id="data" type="text" class="form-control input-sm" placeholder="Type your message here..." />
                        <span class="input-group-btn">
                            <button class="btn btn-warning btn-sm" id="datasend">
                                Send</button>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

    </section>

    <footer>
      <div class="container">
        <p>&copy; Your Website 2018. All Rights Reserved.</p>
        <ul class="list-inline">
          <li class="list-inline-item">
            <a href="#">Privacy</a>
          </li>
          <li class="list-inline-item">
            <a href="#">Terms</a>
          </li>
          <li class="list-inline-item">
            <a href="#">FAQ</a>
          </li>
        </ul>
      </div>
    </footer>

    <!-- Bootstrap core JavaScript -->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Plugin JavaScript -->
    <script src="vendor/jquery-easing/jquery.easing.min.js"></script>

    <!-- Custom scripts for this template -->
    <script src="js/new-age.min.js"></script>

  </body>

</html>

<script src="/socket.io/socket.io.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?callback=initMap" async defer></script>

<script>
	var socket = io.connect('37.59.118.164:3000');
	var myUserName;
	
	var marker;
	var marker2;
	var markers=[];
	var lat;
        var lng;

	socket.on('updatechat', function (username, data,h,m,color) {
	if(myUserName === username){
		$('#conversation').append('<li class="right clearfix"><span class="chat-img pull-right">'+
                            '<img src="http://placehold.it/50/' + color + '/fff&text=ME" alt="User Avatar" class="img-circle" />'+
                        '</span>'+
                            '<div class="chat-body clearfix">'+
                                '<div class="header">'+
                                    '<small class=" text-muted"><span class="glyphicon glyphicon-time"></span>'+h+':'+m+'</small>'+
                                    '<strong class="pull-right primary-font">'+username+'</strong>'+
                                '</div>'+
                                '<p>'+
                                    data+
                                '</p>'+
                            '</div>'+
                        '</li>');
	}else if("SERVER" === username){
		$('#conversation').append('<li class="right clearfix"><span class="chat-img pull-right">'+
                            '<img src="http://placehold.it/50/cc00cc/fff&text=SERV" alt="User Avatar" class="img-circle" />'+
                        '</span>'+
                            '<div class="chat-body clearfix">'+
                                '<div class="header">'+
                                    '<small class=" text-muted"><span class="glyphicon glyphicon-time"></span>'+h+':'+m+'</small>'+
                                    '<strong class="pull-right primary-font">'+username+'</strong>'+
                                '</div>'+
                                '<p>'+
                                    data+
                                '</p>'+
                            '</div>'+
                        '</li>');
	}else{
	$('#conversation').append('<li class="left clearfix"><span class="chat-img pull-left">' + 
                            '<img src="http://placehold.it/50/' + color + '/fff&text='+username.charAt(0).toUpperCase()+'" alt="User Avatar" class="img-circle" />' + 
                        '</span>' + 
                            '<div class="chat-body clearfix">' +
                                '<div class="header">' +
                                    '<strong class="primary-font">'+username+'</strong> <small class="pull-right text-muted">'+
                                        '<span class="glyphicon glyphicon-time"></span>'+h+':'+m+'</small>'+
                                '</div>'+
                                '<p>'+
                                    data+
                                '</p>'+
                            '</div>'+
                        '</li>');
	}
	//$('#conversation').scrollTop($('#conversation')[0].scrollHeight);
	});
	
	socket.on('updateRoomName', function (data) {
		$('#roomName').empty();
		$('#roomName').append("Channel name : "+data);
	});
	
	socket.on('updateUsers', function(usrs) {
		$('#rooms').empty();
		$('#nbUsrs').empty();
		var nb = 0;
		$.each(usrs, function(key, value) {
				$('#rooms').append('<div>' + value + '</div>');
				nb++;
		});
		$('#nbUsrs').append(nb);
	});
	
	socket.on('hideChooseName', function() {
		$('#chooseName').hide();
	});
	
	// on load of page
	$(function(){
		// when the client clicks SEND
		$('#datasend').click( function() {
			var message = $('#data').val();
			$('#data').val('');
			// tell server to execute 'sendchat' and send along one parameter
			socket.emit('sendchat', message);
		});

		// when the client hits ENTER on their keyboard
		$('#data').keypress(function(e) {
			if(e.which == 13) {
				$(this).blur();
				$('#datasend').focus().click();
			}
		});
		
		$('#newUser').submit(function(event){
			myUserName = $('#usr').val();
			event.preventDefault();
			socket.emit('adduser', $('#usr').val());
			$('#usr').val(''); //pour éviter le flood...
			$('#usr').focus(); //pour remettre le focus
		  });
  
		  $('#newRoom').submit(function(event){
			event.preventDefault();
		socket.emit('newRoom', $('#message').val());
		$('#message').val(''); //pour éviter le flood...
		$('#message').focus(); //pour remettre le focus
		  });
	});
	
	
      function initMap() {
        // Create a map object and specify the DOM element for display.
        var map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: 47.480496, lng: -0.592118},
          zoom: 8,
	  gestureHandling: 'greedy'
        });
		
	  var infowindow = new google.maps.InfoWindow({
          content: "Cliquez pour entrer dans le channel de cette zone"
        });
		
		//****************************
		

		google.maps.event.addListener(map,'click', function (event) {
				mapWork(event);
			});


		//************************

		function mapWork(e) {
			if(typeof marker !== "undefined"){marker.setMap(null);}
		  
		  marker = new google.maps.Marker({
			position: e.latLng,
			map: map
		  });
        	  	infowindow.open(map, marker);

	        	  marker.addListener('click', function(){
				if(typeof marker !== "undefined"){marker.setMap(null);}
				  marker = new google.maps.Marker({
					position: e.latLng,
					map: map,
					icon: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png'
				  });
				lat=marker.position.lat();
				lng=marker.position.lng();
				//console.log(lat+";"+lng);
				infowindow.close(map, marker);
				for(i=0;i<4;i++){if(typeof markers[i] !== "undefined"){markers[i].setMap(null);}}
				markers=[];
				//alert("old:"+lat+";"+lng+"new:"+parseFloat(lat.toFixed(2))+";"+parseFloat(lng.toFixed(2)));
				for(i=0;i<4;i++){
				var myLat = lat;var myLng = lng;
					if(i==0){
						markers[i] = new google.maps.Marker({
						position: new google.maps.LatLng(Math.floor(myLat*100)/100,Math.floor(myLng*100)/100),
						title:"a",
						map: map,
						icon: 'http://labs.google.com/ridefinder/images/mm_20_blue.png'
					  });
					}
					if(i==1){
						markers[i] = new google.maps.Marker({
						position: new google.maps.LatLng((Math.floor(myLat*100)/100)+0.01,Math.floor(myLng*100)/100),
						title:"b",
						map: map,
						icon: 'http://labs.google.com/ridefinder/images/mm_20_blue.png'
					  });
					}
					if(i==2){
						markers[i] = new google.maps.Marker({
						position: new google.maps.LatLng(Math.floor(myLat*100)/100,(Math.floor(myLng*100)/100)+0.01),
						title:"c",
						map: map,
						icon: 'http://labs.google.com/ridefinder/images/mm_20_blue.png'
					  });
					}
					if(i==3){
						markers[i] = new google.maps.Marker({
						position: new google.maps.LatLng((Math.floor(myLat*100)/100)+0.01,(Math.floor(myLng*100)/100)+0.01),
						title:"d",
						map: map,
						icon: 'http://labs.google.com/ridefinder/images/mm_20_blue.png'
					  });
					}
				}
				markers.forEach(function(element) {
				  marker2 = new google.maps.Marker({
					position: element,
					map: map
				  });
				});
				socket.emit('newRoom', Math.floor(myLat*100)/100+";"+Math.floor(myLng*100)/100);
          });

          map.setCenter(marker.latLng);
		}
      }
</script>
